---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';

const pageTitle = 'Admin Login - CS {["장찬욱"]};';
---

<Layout title={pageTitle} description="관리자 로그인">
  <div class="max-w-md mx-auto">
    <div class="bg-gray-800 p-8 rounded-lg border border-gray-700">
      <h1 class="text-3xl font-bold mb-6 text-center">관리자 로그인</h1>

      <form id="login-form">
        <div class="mb-4">
          <label class="block text-gray-300 mb-2">비밀번호</label>
          <input
            type="password"
            id="password"
            required
            autofocus
            class="w-full px-4 py-2 bg-gray-700 text-gray-100 rounded border border-gray-600 focus:border-blue-400 outline-none"
            placeholder="관리자 비밀번호 입력"
          />
        </div>

        <div id="error-message" class="hidden mb-4 p-3 bg-red-900 border border-red-700 rounded text-red-200 text-sm">
        </div>

        <button
          type="submit"
          id="login-btn"
          class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded font-medium transition-colors"
        >
          로그인
        </button>
      </form>

      <div class="mt-6 text-center">
        <a href="/" class="text-blue-400 hover:underline text-sm">← 메인으로 돌아가기</a>
      </div>
    </div>
  </div>
</Layout>

<script>
  const API_URL = '';
  const form = document.getElementById('login-form') as HTMLFormElement;
  const passwordInput = document.getElementById('password') as HTMLInputElement;
  const errorMessage = document.getElementById('error-message');
  const loginBtn = document.getElementById('login-btn');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const password = passwordInput.value;

    // Hide previous error
    errorMessage?.classList.add('hidden');

    // Disable button
    if (loginBtn) {
      loginBtn.textContent = '로그인 중...';
      loginBtn.setAttribute('disabled', 'true');
    }

    try {
      const response = await fetch(`${API_URL}/api/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include', // Important for cookies
        body: JSON.stringify({ password })
      });

      const data = await response.json();

      if (response.ok) {
        // Login successful
        alert('로그인 성공!');

        // Redirect to home or previous page
        const redirectTo = new URLSearchParams(window.location.search).get('redirect') || '/';
        window.location.href = redirectTo;
      } else {
        // Show error
        if (errorMessage) {
          errorMessage.textContent = data.error || '로그인에 실패했습니다.';
          errorMessage.classList.remove('hidden');
        }
      }
    } catch (error) {
      console.error('Login error:', error);
      if (errorMessage) {
        errorMessage.textContent = '서버 오류가 발생했습니다.';
        errorMessage.classList.remove('hidden');
      }
    } finally {
      // Re-enable button
      if (loginBtn) {
        loginBtn.textContent = '로그인';
        loginBtn.removeAttribute('disabled');
      }
    }
  });
</script>

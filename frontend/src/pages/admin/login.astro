---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';

const pageTitle = '로그인 - 장찬욱';
---

<Layout title={pageTitle} description="관리자 로그인">
  <div class="max-w-sm mx-auto mt-12">
    <div class="bg-warm-900/50 p-8 rounded-lg border border-warm-800/60">
      <h1 class="text-xl font-semibold text-warm-100 mb-6 text-center tracking-tight">관리자 로그인</h1>

      <form id="login-form">
        <div class="mb-4">
          <label class="block text-warm-400 text-sm mb-2">비밀번호</label>
          <input
            type="password"
            id="password"
            required
            autofocus
            class="w-full px-3 py-2 bg-warm-950 text-warm-100 rounded border border-warm-700 focus:border-accent outline-none transition-colors text-sm"
            placeholder="관리자 비밀번호 입력"
          />
        </div>

        <div id="error-message" class="hidden mb-4 p-3 bg-red-900/30 border border-red-800/50 rounded text-red-300 text-xs">
        </div>

        <button
          type="submit"
          id="login-btn"
          class="w-full px-4 py-2 bg-accent hover:bg-accent-hover text-warm-950 rounded font-medium text-sm transition-colors duration-300"
        >
          로그인
        </button>
      </form>

      <div class="mt-6 text-center">
        <a href="/" class="text-warm-500 hover:text-accent text-sm transition-colors duration-300">&larr; 메인으로</a>
      </div>
    </div>
  </div>
</Layout>

<script>
  const API_URL = import.meta.env.PUBLIC_API_URL || '';
  const form = document.getElementById('login-form') as HTMLFormElement;
  const passwordInput = document.getElementById('password') as HTMLInputElement;
  const errorMessage = document.getElementById('error-message');
  const loginBtn = document.getElementById('login-btn');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const password = passwordInput.value;

    // Hide previous error
    errorMessage?.classList.add('hidden');

    // Disable button
    if (loginBtn) {
      loginBtn.textContent = '로그인 중...';
      loginBtn.setAttribute('disabled', 'true');
    }

    try {
      const response = await fetch(`${API_URL}/api/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include', // Important for cookies
        body: JSON.stringify({ password })
      });

      const data = await response.json();

      if (response.ok) {
        // Login successful
        alert('로그인 성공!');

        // Redirect to home or previous page
        const redirectTo = new URLSearchParams(window.location.search).get('redirect') || '/';
        window.location.href = redirectTo;
      } else {
        // Show error
        if (errorMessage) {
          errorMessage.textContent = data.error || '로그인에 실패했습니다.';
          errorMessage.classList.remove('hidden');
        }
      }
    } catch (error) {
      console.error('Login error:', error);
      if (errorMessage) {
        errorMessage.textContent = '서버 오류가 발생했습니다.';
        errorMessage.classList.remove('hidden');
      }
    } finally {
      // Re-enable button
      if (loginBtn) {
        loginBtn.textContent = '로그인';
        loginBtn.removeAttribute('disabled');
      }
    }
  });
</script>

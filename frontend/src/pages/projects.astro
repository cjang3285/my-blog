---
import Layout from '../layouts/Layout.astro';

const pageTitle = 'Projects - CS {["ì¥ì°¬ìš±"]};';
---

<Layout title={pageTitle} description="ì§„í–‰í•œ í”„ë¡œì íŠ¸ë“¤ì„ ì†Œê°œí•©ë‹ˆë‹¤">
	<div>
		<div class="flex justify-between items-center mb-4">
			<h1 class="text-4xl font-bold">Projects</h1>
			<button id="add-project-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded font-medium">
				+ ìƒˆ í”„ë¡œì íŠ¸ ì¶”ê°€
			</button>
		</div>
		<p class="text-xl text-gray-400 mb-12">
			í•™ìŠµí•˜ë©° ë§Œë“  í”„ë¡œì íŠ¸ë“¤ì…ë‹ˆë‹¤.
		</p>

		<div id="projects-container" class="grid md:grid-cols-2 gap-6 mb-16">
			<!-- Projects will be loaded here -->
		</div>

		<!-- Kanban Board Section -->
		<div class="mt-16 pt-16 border-t border-gray-800">
			<h2 class="text-3xl font-bold mb-8">í”„ë¡œì íŠ¸ ì¹¸ë°˜ë³´ë“œ</h2>
			<p class="text-gray-400 mb-8">í”„ë¡œì íŠ¸ ì§„í–‰ ìƒí™©ì„ ê´€ë¦¬í•©ë‹ˆë‹¤. ì¹´ë“œë¥¼ ë“œë˜ê·¸í•˜ì—¬ ìƒíƒœë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

			<div id="kanban-board" class="grid md:grid-cols-3 gap-6">
				<!-- TODO Column -->
				<div class="kanban-column" data-column="todo">
					<div class="flex justify-between items-center mb-4">
						<h3 class="text-xl font-semibold text-gray-300">ğŸ“‹ Todo</h3>
						<span id="todo-count" class="text-sm text-gray-500">0</span>
					</div>
					<div class="kanban-cards space-y-3 min-h-[400px] p-4 bg-gray-900 rounded-lg" data-column="todo">
						<!-- Cards will be inserted here -->
					</div>
				</div>

				<!-- In Progress Column -->
				<div class="kanban-column" data-column="inprogress">
					<div class="flex justify-between items-center mb-4">
						<h3 class="text-xl font-semibold text-gray-300">ğŸš§ In Progress</h3>
						<span id="inprogress-count" class="text-sm text-gray-500">0</span>
					</div>
					<div class="kanban-cards space-y-3 min-h-[400px] p-4 bg-gray-900 rounded-lg" data-column="inprogress">
						<!-- Cards will be inserted here -->
					</div>
				</div>

				<!-- Done Column -->
				<div class="kanban-column" data-column="done">
					<div class="flex justify-between items-center mb-4">
						<h3 class="text-xl font-semibold text-gray-300">âœ… Done</h3>
						<span id="done-count" class="text-sm text-gray-500">0</span>
					</div>
					<div class="kanban-cards space-y-3 min-h-[400px] p-4 bg-gray-900 rounded-lg" data-column="done">
						<!-- Cards will be inserted here -->
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Add/Edit Project Modal -->
	<div id="project-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
		<div class="bg-gray-800 p-6 rounded-lg w-full max-w-2xl m-4">
			<h3 id="modal-title" class="text-2xl font-semibold mb-4">ìƒˆ í”„ë¡œì íŠ¸ ì¶”ê°€</h3>
			<form id="project-form">
				<input type="hidden" id="project-id" />
				<div class="mb-4">
					<label class="block text-gray-300 mb-2">í”„ë¡œì íŠ¸ ì£¼ì œ *</label>
					<input
						type="text"
						id="project-title"
						required
						class="w-full px-4 py-2 bg-gray-700 text-gray-100 rounded border border-gray-600 focus:border-blue-400 outline-none"
					/>
				</div>
				<div class="mb-4">
					<label class="block text-gray-300 mb-2">ê°„ë‹¨í•œ ì†Œê°œ *</label>
					<textarea
						id="project-description"
						required
						rows="3"
						class="w-full px-4 py-2 bg-gray-700 text-gray-100 rounded border border-gray-600 focus:border-blue-400 outline-none"
					></textarea>
				</div>
				<div class="mb-4">
					<label class="block text-gray-300 mb-2">ê¸°ìˆ  ìŠ¤íƒ (ì‰¼í‘œë¡œ êµ¬ë¶„) *</label>
					<input
						type="text"
						id="project-stack"
						required
						placeholder="ì˜ˆ: React, TypeScript, Node.js"
						class="w-full px-4 py-2 bg-gray-700 text-gray-100 rounded border border-gray-600 focus:border-blue-400 outline-none"
					/>
				</div>
        <div class="mb-4">
					<label class="block text-gray-300 mb-2">GitHub ì£¼ì†Œ *</label>
					<input
						type="url"
						id="project-github_url"
            required
						placeholder="https://github.com/user/repo"
						class="w-full px-4 py-2 bg-gray-700 text-gray-100 rounded border border-gray-600 focus:border-blue-400 outline-none"
					/>
				</div>
				<div class="flex gap-2 justify-end">
					<button
						type="button"
						id="cancel-btn"
						class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded"
					>
						ì·¨ì†Œ
					</button>
					<button
						type="submit"
						class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded"
					>
						ì €ì¥
					</button>
				</div>
			</form>
		</div>
	</div>
</Layout>

<script>
	const API_URL = '';
	let editingProjectId: string | null = null;

	async function loadProjects() {
		try {
			const response = await fetch(`${API_URL}/api/projects`);
			const projects = await response.json();

			const container = document.getElementById('projects-container');
			if (!container) return;

			if (projects.length === 0) {
				container.innerHTML = `
					<div class="col-span-2 text-center py-20">
						<p class="text-gray-400 text-lg mb-4">ì•„ì§ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
						<p class="text-gray-500 text-sm">ìƒˆ í”„ë¡œì íŠ¸ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
					</div>
				`;
				return;
			}

			container.innerHTML = projects.map(project => `
				<article class="p-6 rounded-xl border border-gray-800 flex flex-col">
					<div class="space-y-3 flex-grow">
						<h3 class="text-xl font-semibold">
							<a href="/projects/${project.id}" class="hover:text-blue-400 transition-colors">${project.title}</a>
						</h3>
						<p class="text-gray-400">${project.description}</p>
						${project.stack && project.stack.length > 0 ? `
							<div class="flex flex-wrap gap-2">
								${project.stack.map(tag => `
									<span class="px-3 py-1 text-sm bg-gray-900 rounded-full">${tag}</span>
								`).join('')}
							</div>
						` : ''}
          </div>
					<div class="flex gap-2 pt-4 mt-4">
						${project.github_url ? `
							<a
								href="${project.github_url}"
                target="_blank"
                rel="noopener noreferrer"
								class="inline-flex items-center gap-1 text-blue-400 hover:underline font-medium text-sm"
							>
								GitHub
								<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
								</svg>
							</a>
						` : ''}
						<div class="flex gap-2 ml-auto">
              <button class="edit-project px-3 py-1 bg-yellow-600 hover:bg-yellow-700 rounded text-sm" 
                  data-id="${project.id}"
                  data-title="${encodeURIComponent(project.title)}"
                  data-description="${encodeURIComponent(project.description)}"
                  data-stack="${project.stack.join(',')}"
                  data-github_url="${project.github_url}">
                ìˆ˜ì •
              </button>
							<button class="delete-project px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm" data-id="${project.id}">
								ì‚­ì œ
							</button>
            </div>
					</div>
				</article>
			`).join('');

			// Add edit event listeners
			document.querySelectorAll('.edit-project').forEach(btn => {
				btn.addEventListener('click', (e) => {
					const target = e.target as HTMLElement;
					openEditModal(
						target.dataset.id!,
						decodeURIComponent(target.dataset.title || ''),
						decodeURIComponent(target.dataset.description || ''),
						target.dataset.stack || '',
						target.dataset.github_url || ''
					);
				});
			});

			// Add delete event listeners
			document.querySelectorAll('.delete-project').forEach(btn => {
				btn.addEventListener('click', async (e) => {
					const id = (e.target as HTMLElement).dataset.id;
					if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
						await deleteProject(id!);
					}
				});
			});
		} catch (error) {
			console.error('Failed to load projects:', error);
		}
	}

	async function deleteProject(id: string) {
		try {
			await fetch(`${API_URL}/api/projects/${id}`, {
				method: 'DELETE'
			});
			await loadProjects();
		} catch (error) {
			console.error('Failed to delete project:', error);
			alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
		}
	}

	// Modal handling
	const modal = document.getElementById('project-modal');
	const modalTitle = document.getElementById('modal-title');
	const form = document.getElementById('project-form') as HTMLFormElement;
	const addBtn = document.getElementById('add-project-btn');
	const cancelBtn = document.getElementById('cancel-btn');

	addBtn?.addEventListener('click', () => openNewModal());
	cancelBtn?.addEventListener('click', closeModal);

	function openNewModal() {
		editingProjectId = null;
		if (modalTitle) modalTitle.textContent = 'ìƒˆ í”„ë¡œì íŠ¸ ì¶”ê°€';
    form.reset();
		(document.getElementById('project-id') as HTMLInputElement).value = '';
		modal?.classList.remove('hidden');
	}

  function openEditModal(id: string, title: string, description: string, stack: string, github_url: string) {
		editingProjectId = id;
		if (modalTitle) modalTitle.textContent = 'í”„ë¡œì íŠ¸ ìˆ˜ì •';

		(document.getElementById('project-title') as HTMLInputElement).value = title;
		(document.getElementById('project-description') as HTMLTextAreaElement).value = description;
		(document.getElementById('project-stack') as HTMLInputElement).value = stack;
		(document.getElementById('project-github_url') as HTMLInputElement).value = github_url;
		(document.getElementById('project-id') as HTMLInputElement).value = id;

		modal?.classList.remove('hidden');
	}

	function closeModal() {
		modal?.classList.add('hidden');
		editingProjectId = null;
	}

	form?.addEventListener('submit', async (e) => {
		e.preventDefault();

		const title = (document.getElementById('project-title') as HTMLInputElement).value;
		const description = (document.getElementById('project-description') as HTMLTextAreaElement).value;
		const stackInput = (document.getElementById('project-stack') as HTMLInputElement).value;
    const github_url = (document.getElementById('project-github_url') as HTMLInputElement).value;

		const stack = stackInput ? stackInput.split(',').map(t => t.trim()).filter(t => t) : [];
    const projectData = { title, description, stack, github_url };

		try {
      let response;
			if (editingProjectId) {
				// UPDATE existing project
				response = await fetch(`${API_URL}/api/projects/${editingProjectId}`, {
					method: 'PUT',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(projectData)
				});
			} else {
				// CREATE new project
				response = await fetch(`${API_URL}/api/projects`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(projectData)
				});
			}

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }

			await loadProjects();
			closeModal();
		} catch (error) {
			console.error('Failed to save project:', error);
			alert(error.message);
		}
	});

	// Load initial data
	loadProjects();

	// ============================================
	// KANBAN BOARD FUNCTIONALITY
	// ============================================

	let draggedCard: HTMLElement | null = null;
	let draggedCardId: number | null = null;
	let draggedFromColumn: string | null = null;

	async function loadKanban() {
		try {
			const response = await fetch(`${API_URL}/api/kanban`);
			const data = await response.json();

			renderColumn('todo', data.todo);
			renderColumn('inprogress', data.inprogress);
			renderColumn('done', data.done);
		} catch (error) {
			console.error('Failed to load kanban:', error);
		}
	}

	function renderColumn(column: string, cards: any[]) {
		const container = document.querySelector(`.kanban-cards[data-column="${column}"]`);
		const countEl = document.getElementById(`${column}-count`);

		if (!container) return;

		if (countEl) countEl.textContent = cards.length.toString();

		container.innerHTML = '';
		cards.forEach(card => {
			const cardEl = createCardElement(card, column);
			container.appendChild(cardEl);
		});
	}

	function createCardElement(card: any, column: string) {
		const div = document.createElement('div');
		div.className = 'kanban-card bg-gray-800 p-4 rounded-lg border border-gray-700 hover:border-blue-400 cursor-move transition-colors';
		div.draggable = true;
		div.dataset.cardId = card.id.toString();
		div.dataset.column = column;

		div.innerHTML = `
			<div class="mb-2">
				<h4 class="font-semibold text-gray-100 mb-2">${card.title}</h4>
				<p class="text-sm text-gray-400 mb-3">${card.description || ''}</p>
				${card.stack && card.stack.length > 0 ? `
					<div class="flex flex-wrap gap-1 mb-3">
						${card.stack.map(tech => `<span class="px-2 py-0.5 text-xs bg-gray-900 rounded">${tech}</span>`).join('')}
					</div>
				` : ''}
				${card.github_url ? `
					<a href="${card.github_url}" target="_blank" rel="noopener noreferrer"
					   class="inline-flex items-center gap-1 text-xs text-blue-400 hover:underline"
					   onclick="event.stopPropagation();">
						GitHub
						<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
						</svg>
					</a>
				` : ''}
			</div>
		`;

		// Drag events
		div.addEventListener('dragstart', handleDragStart);
		div.addEventListener('dragend', handleDragEnd);

		return div;
	}

	function handleDragStart(e: DragEvent) {
		const target = e.target as HTMLElement;
		draggedCard = target;
		draggedCardId = parseInt(target.dataset.cardId || '0');
		draggedFromColumn = target.dataset.column || null;
		target.classList.add('opacity-50');
	}

	function handleDragEnd(e: DragEvent) {
		const target = e.target as HTMLElement;
		target.classList.remove('opacity-50');
	}

	function handleDragOver(e: DragEvent) {
		e.preventDefault();
	}

	async function handleDrop(e: DragEvent, column: string) {
		e.preventDefault();

		if (!draggedCardId || !draggedFromColumn) return;

		const container = e.currentTarget as HTMLElement;
		const cards = Array.from(container.querySelectorAll('.kanban-card'));
		const toIndex = cards.length;

		try {
			await fetch(`${API_URL}/api/kanban/move`, {
				method: 'PUT',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					cardId: draggedCardId,
					fromColumn: draggedFromColumn,
					toColumn: column,
					toIndex
				})
			});

			await loadKanban();
		} catch (error) {
			console.error('Failed to move card:', error);
			alert('ì¹´ë“œ ì´ë™ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
		}
	}

	// Set up drag and drop on columns
	document.querySelectorAll('.kanban-cards').forEach(column => {
		column.addEventListener('dragover', handleDragOver);
		column.addEventListener('drop', (e) => {
			const col = (e.currentTarget as HTMLElement).dataset.column!;
			handleDrop(e as DragEvent, col);
		});
	});

	// Load kanban board
	loadKanban();

	// Reload kanban when a project is added/updated/deleted
	const originalLoadProjects = loadProjects;
	loadProjects = async function() {
		await originalLoadProjects();
		await loadKanban();
	};
</script>

---
import Layout from '../layouts/Layout.astro';

const pageTitle = 'Projects - CS {["장찬욱"]};';
---

<Layout title={pageTitle} description="진행한 프로젝트들을 소개합니다">
	<div>
		<div class="flex justify-between items-center mb-4">
			<h1 class="text-4xl font-bold">Projects</h1>
			<button id="add-project-btn" style="display: none;" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded font-medium">
				+ 새 프로젝트 추가
			</button>
		</div>
		<p class="text-xl text-gray-400 mb-12">
			학습하며 만든 프로젝트들입니다.
		</p>

		<div id="projects-container" class="grid md:grid-cols-2 gap-6 mb-16">
			<!-- Projects will be loaded here -->
		</div>
	</div>

	<!-- Add/Edit Project Modal -->
	<div id="project-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
		<div class="bg-gray-800 p-6 rounded-lg w-full max-w-2xl m-4">
			<h3 id="modal-title" class="text-2xl font-semibold mb-4">새 프로젝트 추가</h3>
			<form id="project-form">
				<input type="hidden" id="project-id" />
				<div class="mb-4">
					<label class="block text-gray-300 mb-2">프로젝트 주제 *</label>
					<input
						type="text"
						id="project-title"
						required
						class="w-full px-4 py-2 bg-gray-700 text-gray-100 rounded border border-gray-600 focus:border-blue-400 outline-none"
					/>
				</div>
				<div class="mb-4">
					<label class="block text-gray-300 mb-2">간단한 소개 * (리스트에 표시)</label>
					<textarea
						id="project-description"
						required
						rows="2"
						placeholder="프로젝트의 핵심 내용을 간단히 요약해주세요"
						class="w-full px-4 py-2 bg-gray-700 text-gray-100 rounded border border-gray-600 focus:border-blue-400 outline-none"
					></textarea>
				</div>
				<div class="mb-4">
					<label class="block text-gray-300 mb-2">상세 본문 (상세 페이지에 표시)</label>
					<textarea
						id="project-content"
						rows="6"
						placeholder="프로젝트의 목적, 구현 내용, 배운 점 등을 자세히 작성해주세요"
						class="w-full px-4 py-2 bg-gray-700 text-gray-100 rounded border border-gray-600 focus:border-blue-400 outline-none"
					></textarea>
				</div>
				<div class="mb-4">
					<label class="block text-gray-300 mb-2">기술 스택 (쉼표로 구분) *</label>
					<input
						type="text"
						id="project-stack"
						required
						placeholder="예: React, TypeScript, Node.js"
						class="w-full px-4 py-2 bg-gray-700 text-gray-100 rounded border border-gray-600 focus:border-blue-400 outline-none"
					/>
				</div>
        <div class="mb-4">
					<label class="block text-gray-300 mb-2">GitHub 주소 *</label>
					<input
						type="url"
						id="project-github_url"
            required
						placeholder="https://github.com/user/repo"
						class="w-full px-4 py-2 bg-gray-700 text-gray-100 rounded border border-gray-600 focus:border-blue-400 outline-none"
					/>
				</div>
				<div class="flex gap-2 justify-end">
					<button
						type="button"
						id="cancel-btn"
						class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded"
					>
						취소
					</button>
					<button
						type="submit"
						class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded"
					>
						저장
					</button>
				</div>
			</form>
		</div>
	</div>
</Layout>

<script>
	const API_URL = import.meta.env.PUBLIC_API_URL || '';
	let editingProjectId: string | null = null;
	let isAuthenticated = false;

	// Check authentication status
	async function checkAuth() {
		try {
			const response = await fetch(`${API_URL}/api/auth/check`, {
				credentials: 'include'
			});
			const data = await response.json();
			isAuthenticated = data.isAuthenticated;

			// Show/hide add button
			const addBtn = document.getElementById('add-project-btn');
			if (addBtn) {
				addBtn.style.display = isAuthenticated ? 'block' : 'none';
			}
		} catch (error) {
			console.error('Auth check failed:', error);
			isAuthenticated = false;
		}
	}

	async function loadProjects() {
		try {
			console.log('[PROJECTS] API_URL:', API_URL);
			console.log('[PROJECTS] Fetching projects from:', `${API_URL}/api/projects`);
			const response = await fetch(`${API_URL}/api/projects`);
			console.log('[PROJECTS] Response status:', response.status);

			if (!response.ok) {
				throw new Error(`HTTP ${response.status}`);
			}

			const projects = await response.json();
			console.log('[PROJECTS] Loaded projects:', projects.length);

			const container = document.getElementById('projects-container');
			if (!container) {
				console.error('[PROJECTS] Container not found');
				return;
			}

			if (projects.length === 0) {
				container.innerHTML = `
					<div class="col-span-2 text-center py-20">
						<p class="text-gray-400 text-lg mb-4">아직 프로젝트가 없습니다.</p>
						<p class="text-gray-500 text-sm">새 프로젝트를 추가해보세요!</p>
					</div>
				`;
				return;
			}

			container.innerHTML = projects.map(project => `
				<article class="p-6 rounded-xl border border-gray-800 flex flex-col">
					<div class="space-y-3 flex-grow">
						<h3 class="text-xl font-semibold">
							<a href="/projects/${project.id}" class="hover:text-blue-400 transition-colors">${project.title}</a>
						</h3>
						<p class="text-gray-400">${project.description}</p>
						${project.stack && project.stack.length > 0 ? `
							<div class="flex flex-wrap gap-2">
								${project.stack.map(tag => `
									<span class="px-3 py-1 text-sm bg-gray-900 rounded-full">${tag}</span>
								`).join('')}
							</div>
						` : ''}
          </div>
					<div class="flex gap-2 pt-4 mt-4">
						${project.github_url ? `
							<a
								href="${project.github_url}"
                target="_blank"
                rel="noopener noreferrer"
								class="inline-flex items-center gap-1 text-blue-400 hover:underline font-medium text-sm"
							>
								GitHub
								<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
								</svg>
							</a>
						` : ''}
					</div>
				</article>
			`).join('');
		} catch (error) {
			console.error('[PROJECTS] Failed to load projects:', error);
			const container = document.getElementById('projects-container');
			if (container) {
				container.innerHTML = `
					<div class="col-span-2 text-center py-20">
						<p class="text-red-400 text-lg mb-4">프로젝트를 불러오는데 실패했습니다.</p>
						<p class="text-gray-500 text-sm">에러: ${error.message}</p>
						<p class="text-gray-500 text-sm">API URL: ${API_URL || '미설정'}</p>
					</div>
				`;
			}
		}
	}

	// Modal handling
	const modal = document.getElementById('project-modal');
	const modalTitle = document.getElementById('modal-title');
	const form = document.getElementById('project-form') as HTMLFormElement;
	const addBtn = document.getElementById('add-project-btn');
	const cancelBtn = document.getElementById('cancel-btn');

	addBtn?.addEventListener('click', () => openNewModal());
	cancelBtn?.addEventListener('click', closeModal);

	function openNewModal() {
		editingProjectId = null;
		if (modalTitle) modalTitle.textContent = '새 프로젝트 추가';
    form.reset();
		(document.getElementById('project-id') as HTMLInputElement).value = '';
		modal?.classList.remove('hidden');
	}

	function closeModal() {
		modal?.classList.add('hidden');
		editingProjectId = null;
	}

	form?.addEventListener('submit', async (e) => {
		e.preventDefault();

		const title = (document.getElementById('project-title') as HTMLInputElement).value;
		const description = (document.getElementById('project-description') as HTMLTextAreaElement).value;
		const content = (document.getElementById('project-content') as HTMLTextAreaElement).value;
		const stackInput = (document.getElementById('project-stack') as HTMLInputElement).value;
    const github_url = (document.getElementById('project-github_url') as HTMLInputElement).value;

		const stack = stackInput ? stackInput.split(',').map(t => t.trim()).filter(t => t) : [];
    const projectData = { title, description, content, stack, github_url };

		try {
			// CREATE new project
			const response = await fetch(`${API_URL}/api/projects`, {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(projectData),
				credentials: 'include'
			});

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || '저장에 실패했습니다.');
      }

			await loadProjects();
			closeModal();
		} catch (error) {
			console.error('Failed to save project:', error);
			alert(error.message);
		}
	});

	// Load initial data
	(async () => {
		await checkAuth();
		await loadProjects();
	})();
</script>

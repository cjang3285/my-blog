---
import Layout from '../layouts/Layout.astro';

const pageTitle = 'Projects - CS {["장찬욱"]};';
---

<Layout title={pageTitle} description="진행한 프로젝트들을 소개합니다">
	<div>
		<div class="flex justify-between items-center mb-4">
			<h1 class="text-4xl font-bold">Projects</h1>
			<button id="add-project-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded font-medium">
				+ 새 프로젝트 추가
			</button>
		</div>
		<p class="text-xl text-gray-400 mb-12">
			학습하며 만든 프로젝트들입니다.
		</p>

		<div id="projects-container" class="grid md:grid-cols-2 gap-6">
			<!-- Projects will be loaded here -->
		</div>
	</div>

	<!-- Add/Edit Project Modal -->
	<div id="project-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
		<div class="bg-gray-800 p-6 rounded-lg w-full max-w-2xl m-4">
			<h3 id="modal-title" class="text-2xl font-semibold mb-4">새 프로젝트 추가</h3>
			<form id="project-form">
				<input type="hidden" id="project-id" />
				<div class="mb-4">
					<label class="block text-gray-300 mb-2">프로젝트 주제 *</label>
					<input
						type="text"
						id="project-title"
						required
						class="w-full px-4 py-2 bg-gray-700 text-gray-100 rounded border border-gray-600 focus:border-blue-400 outline-none"
					/>
				</div>
				<div class="mb-4">
					<label class="block text-gray-300 mb-2">간단한 소개 *</label>
					<textarea
						id="project-description"
						required
						rows="3"
						class="w-full px-4 py-2 bg-gray-700 text-gray-100 rounded border border-gray-600 focus:border-blue-400 outline-none"
					></textarea>
				</div>
				<div class="mb-4">
					<label class="block text-gray-300 mb-2">기술 스택 (쉼표로 구분) *</label>
					<input
						type="text"
						id="project-stack"
						required
						placeholder="예: React, TypeScript, Node.js"
						class="w-full px-4 py-2 bg-gray-700 text-gray-100 rounded border border-gray-600 focus:border-blue-400 outline-none"
					/>
				</div>
        <div class="mb-4">
					<label class="block text-gray-300 mb-2">GitHub 주소 *</label>
					<input
						type="url"
						id="project-github_url"
            required
						placeholder="https://github.com/user/repo"
						class="w-full px-4 py-2 bg-gray-700 text-gray-100 rounded border border-gray-600 focus:border-blue-400 outline-none"
					/>
				</div>
				<div class="flex gap-2 justify-end">
					<button
						type="button"
						id="cancel-btn"
						class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded"
					>
						취소
					</button>
					<button
						type="submit"
						class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded"
					>
						저장
					</button>
				</div>
			</form>
		</div>
	</div>
</Layout>

<script>
	const API_URL = '';
	let editingProjectId: string | null = null;

	async function loadProjects() {
		try {
			const response = await fetch(`${API_URL}/api/projects`);
			const projects = await response.json();

			const container = document.getElementById('projects-container');
			if (!container) return;

			if (projects.length === 0) {
				container.innerHTML = `
					<div class="col-span-2 text-center py-20">
						<p class="text-gray-400 text-lg mb-4">아직 프로젝트가 없습니다.</p>
						<p class="text-gray-500 text-sm">새 프로젝트를 추가해보세요!</p>
					</div>
				`;
				return;
			}

			container.innerHTML = projects.map(project => `
				<article class="p-6 rounded-xl border border-gray-800 flex flex-col">
					<div class="space-y-3 flex-grow">
						<h3 class="text-xl font-semibold">
							<a href="/projects/${project.id}" class="hover:text-blue-400 transition-colors">${project.title}</a>
						</h3>
						<p class="text-gray-400">${project.description}</p>
						${project.stack && project.stack.length > 0 ? `
							<div class="flex flex-wrap gap-2">
								${project.stack.map(tag => `
									<span class="px-3 py-1 text-sm bg-gray-900 rounded-full">${tag}</span>
								`).join('')}
							</div>
						` : ''}
          </div>
					<div class="flex gap-2 pt-4 mt-4">
						${project.github_url ? `
							<a
								href="${project.github_url}"
                target="_blank"
                rel="noopener noreferrer"
								class="inline-flex items-center gap-1 text-blue-400 hover:underline font-medium text-sm"
							>
								GitHub
								<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
								</svg>
							</a>
						` : ''}
						<div class="flex gap-2 ml-auto">
              <button class="edit-project px-3 py-1 bg-yellow-600 hover:bg-yellow-700 rounded text-sm" 
                  data-id="${project.id}"
                  data-title="${encodeURIComponent(project.title)}"
                  data-description="${encodeURIComponent(project.description)}"
                  data-stack="${project.stack.join(',')}"
                  data-github_url="${project.github_url}">
                수정
              </button>
							<button class="delete-project px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm" data-id="${project.id}">
								삭제
							</button>
            </div>
					</div>
				</article>
			`).join('');

			// Add edit event listeners
			document.querySelectorAll('.edit-project').forEach(btn => {
				btn.addEventListener('click', (e) => {
					const target = e.target as HTMLElement;
					openEditModal(
						target.dataset.id!,
						decodeURIComponent(target.dataset.title || ''),
						decodeURIComponent(target.dataset.description || ''),
						target.dataset.stack || '',
						target.dataset.github_url || ''
					);
				});
			});

			// Add delete event listeners
			document.querySelectorAll('.delete-project').forEach(btn => {
				btn.addEventListener('click', async (e) => {
					const id = (e.target as HTMLElement).dataset.id;
					if (confirm('정말 삭제하시겠습니까?')) {
						await deleteProject(id!);
					}
				});
			});
		} catch (error) {
			console.error('Failed to load projects:', error);
		}
	}

	async function deleteProject(id: string) {
		try {
			await fetch(`${API_URL}/api/projects/${id}`, {
				method: 'DELETE'
			});
			await loadProjects();
		} catch (error) {
			console.error('Failed to delete project:', error);
			alert('삭제에 실패했습니다.');
		}
	}

	// Modal handling
	const modal = document.getElementById('project-modal');
	const modalTitle = document.getElementById('modal-title');
	const form = document.getElementById('project-form') as HTMLFormElement;
	const addBtn = document.getElementById('add-project-btn');
	const cancelBtn = document.getElementById('cancel-btn');

	addBtn?.addEventListener('click', () => openNewModal());
	cancelBtn?.addEventListener('click', closeModal);

	function openNewModal() {
		editingProjectId = null;
		if (modalTitle) modalTitle.textContent = '새 프로젝트 추가';
    form.reset();
		(document.getElementById('project-id') as HTMLInputElement).value = '';
		modal?.classList.remove('hidden');
	}

  function openEditModal(id: string, title: string, description: string, stack: string, github_url: string) {
		editingProjectId = id;
		if (modalTitle) modalTitle.textContent = '프로젝트 수정';

		(document.getElementById('project-title') as HTMLInputElement).value = title;
		(document.getElementById('project-description') as HTMLTextAreaElement).value = description;
		(document.getElementById('project-stack') as HTMLInputElement).value = stack;
		(document.getElementById('project-github_url') as HTMLInputElement).value = github_url;
		(document.getElementById('project-id') as HTMLInputElement).value = id;

		modal?.classList.remove('hidden');
	}

	function closeModal() {
		modal?.classList.add('hidden');
		editingProjectId = null;
	}

	form?.addEventListener('submit', async (e) => {
		e.preventDefault();

		const title = (document.getElementById('project-title') as HTMLInputElement).value;
		const description = (document.getElementById('project-description') as HTMLTextAreaElement).value;
		const stackInput = (document.getElementById('project-stack') as HTMLInputElement).value;
    const github_url = (document.getElementById('project-github_url') as HTMLInputElement).value;

		const stack = stackInput ? stackInput.split(',').map(t => t.trim()).filter(t => t) : [];
    const projectData = { title, description, stack, github_url };

		try {
      let response;
			if (editingProjectId) {
				// UPDATE existing project
				response = await fetch(`${API_URL}/api/projects/${editingProjectId}`, {
					method: 'PUT',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(projectData)
				});
			} else {
				// CREATE new project
				response = await fetch(`${API_URL}/api/projects`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(projectData)
				});
			}

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || '저장에 실패했습니다.');
      }

			await loadProjects();
			closeModal();
		} catch (error) {
			console.error('Failed to save project:', error);
			alert(error.message);
		}
	});

	// Load initial data
	loadProjects();
</script>

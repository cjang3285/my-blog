---
import Layout from '../layouts/Layout.astro';

const pageTitle = '글 - 장찬욱';
---

<Layout title={pageTitle} description="모든 블로그 글 보기">
	<div>
		<div class="flex justify-between items-center mb-3">
			<h1 class="text-2xl font-semibold text-warm-100 tracking-tight">글</h1>
			<button id="add-post-btn" style="display: none;" class="px-3 py-1.5 bg-accent hover:bg-accent-hover text-warm-950 rounded text-sm font-medium transition-colors duration-300">
				+ 새 글 작성
			</button>
		</div>
		<p class="text-warm-500 text-sm mb-10">
			배운 것들을 기록하고 공유합니다.
		</p>

		<div id="posts-container">
			<!-- Posts will be loaded here -->
		</div>
	</div>

	<!-- Add/Edit Post Modal -->
	<div id="post-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 overflow-y-auto backdrop-blur-sm">
		<div class="bg-warm-900 border border-warm-800 p-6 rounded-lg w-full max-w-2xl m-4">
			<h3 id="modal-title" class="text-xl font-semibold text-warm-100 mb-4">새 글 작성</h3>
			<form id="post-form">
				<input type="hidden" id="post-id" />
				<div class="mb-4">
					<label class="block text-warm-400 text-sm mb-2">제목 *</label>
					<input
						type="text"
						id="post-title"
						required
						class="w-full px-3 py-2 bg-warm-950 text-warm-100 rounded border border-warm-700 focus:border-accent outline-none transition-colors text-sm"
					/>
				</div>
				<div class="mb-4">
					<label class="block text-warm-400 text-sm mb-2">요약 *</label>
					<textarea
						id="post-excerpt"
						required
						rows="2"
						class="w-full px-3 py-2 bg-warm-950 text-warm-100 rounded border border-warm-700 focus:border-accent outline-none transition-colors text-sm"
					></textarea>
				</div>
				<div class="mb-4">
					<label class="block text-warm-400 text-sm mb-2">본문 *</label>
					<textarea
						id="post-content"
						required
						rows="8"
						class="w-full px-3 py-2 bg-warm-950 text-warm-100 rounded border border-warm-700 focus:border-accent outline-none transition-colors text-sm"
					></textarea>
				</div>
				<div class="mb-4">
					<label class="block text-warm-400 text-sm mb-2">태그 (쉼표로 구분)</label>
					<input
						type="text"
						id="post-tags"
						placeholder="예: JavaScript, React, Web"
						class="w-full px-3 py-2 bg-warm-950 text-warm-100 rounded border border-warm-700 focus:border-accent outline-none transition-colors text-sm"
					/>
				</div>
				<div class="mb-4">
					<label class="flex items-center text-warm-400 text-sm">
						<input type="checkbox" id="post-featured" class="mr-2" />
						Featured (메인 페이지에 표시)
					</label>
				</div>
				<div class="flex gap-2 justify-end">
					<button
						type="button"
						id="cancel-btn"
						class="px-3 py-1.5 bg-warm-800 hover:bg-warm-700 rounded text-sm text-warm-300 transition-colors"
					>
						취소
					</button>
					<button
						type="submit"
						class="px-3 py-1.5 bg-accent hover:bg-accent-hover text-warm-950 rounded text-sm font-medium transition-colors"
					>
						저장
					</button>
				</div>
			</form>
		</div>
	</div>
</Layout>

<script>
	const API_URL = import.meta.env.PUBLIC_API_URL || '';
	let editingPostId: string | null = null;
	let isAuthenticated = false;

	// Check authentication status
	async function checkAuth() {
		try {
			const response = await fetch(`${API_URL}/api/auth/check`, {
				credentials: 'include'
			});
			const data = await response.json();
			isAuthenticated = data.isAuthenticated;

			// Show/hide add button
			const addBtn = document.getElementById('add-post-btn');
			if (addBtn) {
				addBtn.style.display = isAuthenticated ? 'block' : 'none';
			}
		} catch (error) {
			console.error('Auth check failed:', error);
			isAuthenticated = false;
		}
	}

	async function loadPosts() {
		try {
			console.log('[BLOG] API_URL:', API_URL);
			console.log('[BLOG] Fetching posts from:', `${API_URL}/api/posts`);
			const response = await fetch(`${API_URL}/api/posts`);
			console.log('[BLOG] Response status:', response.status);

			if (!response.ok) {
				throw new Error(`HTTP ${response.status}`);
			}

			const posts = await response.json();
			console.log('[BLOG] Loaded posts:', posts.length);

			const container = document.getElementById('posts-container');
			if (!container) {
				console.error('[BLOG] Container not found');
				return;
			}

			if (posts.length === 0) {
				container.innerHTML = `
					<div class="text-center py-20">
						<p class="text-warm-500 text-sm mb-2">아직 글이 없습니다.</p>
						<p class="text-warm-600 text-xs">새 글을 작성해보세요!</p>
					</div>
				`;
				return;
			}

			container.innerHTML = posts.map(post => `
				<article class="group py-6 border-b border-warm-800/50">
					<div class="flex items-center gap-2 text-sm text-warm-500 mb-2">
						<time>${new Date(post.date).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}</time>
						${post.tags && post.tags.length > 0 ? `
							<span class="text-warm-700">/</span>
							<div class="flex gap-1.5">
								${post.tags.map(tag => `<span class="text-warm-500">${tag}</span>`).join('')}
							</div>
						` : ''}
						${post.featured ? '<span class="ml-auto px-2 py-0.5 bg-accent/20 text-accent text-xs rounded">Featured</span>' : ''}
					</div>
					<h3 class="text-lg font-medium text-warm-100 mb-1.5">
						<a href="/blog/${post.slug}" class="hover:text-accent transition-colors duration-300">${post.title}</a>
					</h3>
					<p class="text-warm-400 text-sm">${post.excerpt}</p>
				</article>
			`).join('');
		} catch (error) {
			console.error('[BLOG] Failed to load posts:', error);
			const container = document.getElementById('posts-container');
			if (container) {
				container.innerHTML = `
					<div class="text-center py-20">
						<p class="text-red-400 text-sm mb-2">글을 불러오는데 실패했습니다.</p>
						<p class="text-warm-600 text-xs">에러: ${error.message}</p>
						<p class="text-warm-600 text-xs">API URL: ${API_URL || '미설정'}</p>
					</div>
				`;
			}
		}
	}

	// Modal handling
	const modal = document.getElementById('post-modal');
	const modalTitle = document.getElementById('modal-title');
	const form = document.getElementById('post-form') as HTMLFormElement;
	const addBtn = document.getElementById('add-post-btn');
	const cancelBtn = document.getElementById('cancel-btn');

	addBtn?.addEventListener('click', () => {
		openNewModal();
	});

	cancelBtn?.addEventListener('click', closeModal);

	function openNewModal() {
		editingPostId = null;
		if (modalTitle) modalTitle.textContent = '새 글 작성';

		(document.getElementById('post-title') as HTMLInputElement).value = '';
		(document.getElementById('post-excerpt') as HTMLTextAreaElement).value = '';
		(document.getElementById('post-content') as HTMLTextAreaElement).value = '';
		(document.getElementById('post-tags') as HTMLInputElement).value = '';
		(document.getElementById('post-featured') as HTMLInputElement).checked = false;
		(document.getElementById('post-id') as HTMLInputElement).value = '';

		modal?.classList.remove('hidden');
	}

	function closeModal() {
		modal?.classList.add('hidden');
		editingPostId = null;
	}

	form?.addEventListener('submit', async (e) => {
		e.preventDefault();

		const title = (document.getElementById('post-title') as HTMLInputElement).value;
		const excerpt = (document.getElementById('post-excerpt') as HTMLTextAreaElement).value;
		const content = (document.getElementById('post-content') as HTMLTextAreaElement).value;
		const tagsInput = (document.getElementById('post-tags') as HTMLInputElement).value;
		const featured = (document.getElementById('post-featured') as HTMLInputElement).checked;

		const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

		try {
			if (editingPostId) {
				// UPDATE existing post
				await fetch(`${API_URL}/api/posts/${editingPostId}`, {
					method: 'PUT',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ title, excerpt, content, tags, featured })
				});
			} else {
				// CREATE new post
				await fetch(`${API_URL}/api/posts`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ title, excerpt, content, tags, featured })
				});
			}

			await loadPosts();
			closeModal();
		} catch (error) {
			console.error('Failed to save post:', error);
			alert('저장에 실패했습니다.');
		}
	});

	// Load initial data
	(async () => {
		await checkAuth();
		await loadPosts();
	})();
</script>

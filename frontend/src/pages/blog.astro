---
import Layout from '../layouts/Layout.astro';

const pageTitle = 'Posts - CS {["장찬욱"]};';
---

<Layout title={pageTitle} description="모든 블로그 글 보기">
	<div class="max-w-3xl">
		<div class="flex justify-between items-center mb-4">
			<h1 class="text-4xl font-bold">Posts</h1>
			<button id="add-post-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded font-medium">
				+ 새 글 작성
			</button>
		</div>
		<p class="text-xl text-gray-400 mb-12">
			배운 것들을 기록하고 공유합니다.
		</p>

		<div id="posts-container" class="grid gap-6">
			<!-- Posts will be loaded here -->
		</div>
	</div>

	<!-- Add/Edit Post Modal -->
	<div id="post-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
		<div class="bg-gray-800 p-6 rounded-lg w-full max-w-2xl m-4">
			<h3 id="modal-title" class="text-2xl font-semibold mb-4">새 글 작성</h3>
			<form id="post-form">
				<input type="hidden" id="post-id" />
				<div class="mb-4">
					<label class="block text-gray-300 mb-2">제목 *</label>
					<input
						type="text"
						id="post-title"
						required
						class="w-full px-4 py-2 bg-gray-700 text-gray-100 rounded border border-gray-600 focus:border-blue-400 outline-none"
					/>
				</div>
				<div class="mb-4">
					<label class="block text-gray-300 mb-2">요약 *</label>
					<textarea
						id="post-excerpt"
						required
						rows="2"
						class="w-full px-4 py-2 bg-gray-700 text-gray-100 rounded border border-gray-600 focus:border-blue-400 outline-none"
					></textarea>
				</div>
				<div class="mb-4">
					<label class="block text-gray-300 mb-2">본문 *</label>
					<textarea
						id="post-content"
						required
						rows="8"
						class="w-full px-4 py-2 bg-gray-700 text-gray-100 rounded border border-gray-600 focus:border-blue-400 outline-none"
					></textarea>
				</div>
				<div class="mb-4">
					<label class="block text-gray-300 mb-2">태그 (쉼표로 구분)</label>
					<input
						type="text"
						id="post-tags"
						placeholder="예: JavaScript, React, Web"
						class="w-full px-4 py-2 bg-gray-700 text-gray-100 rounded border border-gray-600 focus:border-blue-400 outline-none"
					/>
				</div>
				<div class="mb-4">
					<label class="flex items-center text-gray-300">
						<input type="checkbox" id="post-featured" class="mr-2" />
						Featured (메인 페이지에 표시)
					</label>
				</div>
				<div class="flex gap-2 justify-end">
					<button
						type="button"
						id="cancel-btn"
						class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded"
					>
						취소
					</button>
					<button
						type="submit"
						class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded"
					>
						저장
					</button>
				</div>
			</form>
		</div>
	</div>
</Layout>

<script>
	const API_URL = '';
	let editingPostId: string | null = null;

	async function loadPosts() {
		try {
			const response = await fetch(`${API_URL}/api/posts`);
			const posts = await response.json();

			const container = document.getElementById('posts-container');
			if (!container) return;

			if (posts.length === 0) {
				container.innerHTML = `
					<div class="text-center py-20">
						<p class="text-gray-400 text-lg mb-4">아직 글이 없습니다.</p>
						<p class="text-gray-500 text-sm">새 글을 작성해보세요!</p>
					</div>
				`;
				return;
			}

			container.innerHTML = posts.map(post => `
				<article class="group p-6 rounded-xl border border-gray-800 transition-colors">
					<div class="flex items-center gap-2 text-sm text-gray-400 mb-3">
						<time>${new Date(post.date).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}</time>
						${post.tags && post.tags.length > 0 ? `
							<span>•</span>
							<div class="flex gap-2">
								${post.tags.map(tag => `<span class="text-blue-400">#${tag}</span>`).join('')}
							</div>
						` : ''}
						${post.featured ? '<span class="ml-auto px-2 py-1 bg-blue-600 text-xs rounded">Featured</span>' : ''}
					</div>
					<h3 class="text-2xl font-semibold mb-2">
						<a href="/blog/${post.slug}" class="hover:text-blue-400 transition-colors">${post.title}</a>
					</h3>
					<p class="text-gray-400 mb-4">${post.excerpt}</p>
					<div class="flex gap-2 justify-end">
						<button class="edit-post px-3 py-1 bg-yellow-600 hover:bg-yellow-700 rounded text-sm"
								data-id="${post.id}"
								data-title="${encodeURIComponent(post.title)}"
								data-excerpt="${encodeURIComponent(post.excerpt || '')}"
								data-content="${encodeURIComponent(post.content || '')}"
								data-tags="${post.tags ? post.tags.join(',') : ''}"
								data-featured="${post.featured}">
							수정
						</button>
						<button class="delete-post px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm" data-id="${post.id}">
							삭제
						</button>
					</div>
				</article>
			`).join('');

			// Add edit event listeners
			document.querySelectorAll('.edit-post').forEach(btn => {
				btn.addEventListener('click', (e) => {
					const target = e.target as HTMLElement;
					openEditModal(
						target.dataset.id!,
						decodeURIComponent(target.dataset.title || ''),
						decodeURIComponent(target.dataset.excerpt || ''),
						decodeURIComponent(target.dataset.content || ''),
						target.dataset.tags || '',
						target.dataset.featured === 'true'
					);
				});
			});

			// Add delete event listeners
			document.querySelectorAll('.delete-post').forEach(btn => {
				btn.addEventListener('click', async (e) => {
					const id = (e.target as HTMLElement).dataset.id;
					if (confirm('정말 삭제하시겠습니까?')) {
						await deletePost(id!);
					}
				});
			});
		} catch (error) {
			console.error('Failed to load posts:', error);
		}
	}

	async function deletePost(id: string) {
		try {
			await fetch(`${API_URL}/api/posts/${id}`, {
				method: 'DELETE'
			});
			await loadPosts();
		} catch (error) {
			console.error('Failed to delete post:', error);
			alert('삭제에 실패했습니다.');
		}
	}

	// Modal handling
	const modal = document.getElementById('post-modal');
	const modalTitle = document.getElementById('modal-title');
	const form = document.getElementById('post-form') as HTMLFormElement;
	const addBtn = document.getElementById('add-post-btn');
	const cancelBtn = document.getElementById('cancel-btn');

	addBtn?.addEventListener('click', () => {
		openNewModal();
	});

	cancelBtn?.addEventListener('click', closeModal);

	function openNewModal() {
		editingPostId = null;
		if (modalTitle) modalTitle.textContent = '새 글 작성';

		(document.getElementById('post-title') as HTMLInputElement).value = '';
		(document.getElementById('post-excerpt') as HTMLTextAreaElement).value = '';
		(document.getElementById('post-content') as HTMLTextAreaElement).value = '';
		(document.getElementById('post-tags') as HTMLInputElement).value = '';
		(document.getElementById('post-featured') as HTMLInputElement).checked = false;
		(document.getElementById('post-id') as HTMLInputElement).value = '';

		modal?.classList.remove('hidden');
	}

	function openEditModal(id: string, title: string, excerpt: string, content: string, tags: string, featured: boolean) {
		editingPostId = id;
		if (modalTitle) modalTitle.textContent = '글 수정';

		(document.getElementById('post-title') as HTMLInputElement).value = title;
		(document.getElementById('post-excerpt') as HTMLTextAreaElement).value = excerpt;
		(document.getElementById('post-content') as HTMLTextAreaElement).value = content;
		(document.getElementById('post-tags') as HTMLInputElement).value = tags;
		(document.getElementById('post-featured') as HTMLInputElement).checked = featured;
		(document.getElementById('post-id') as HTMLInputElement).value = id;

		modal?.classList.remove('hidden');
	}

	function closeModal() {
		modal?.classList.add('hidden');
		editingPostId = null;
	}

	form?.addEventListener('submit', async (e) => {
		e.preventDefault();

		const title = (document.getElementById('post-title') as HTMLInputElement).value;
		const excerpt = (document.getElementById('post-excerpt') as HTMLTextAreaElement).value;
		const content = (document.getElementById('post-content') as HTMLTextAreaElement).value;
		const tagsInput = (document.getElementById('post-tags') as HTMLInputElement).value;
		const featured = (document.getElementById('post-featured') as HTMLInputElement).checked;

		const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

		try {
			if (editingPostId) {
				// UPDATE existing post
				await fetch(`${API_URL}/api/posts/${editingPostId}`, {
					method: 'PUT',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ title, excerpt, content, tags, featured })
				});
			} else {
				// CREATE new post
				await fetch(`${API_URL}/api/posts`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ title, excerpt, content, tags, featured })
				});
			}

			await loadPosts();
			closeModal();
		} catch (error) {
			console.error('Failed to save post:', error);
			alert('저장에 실패했습니다.');
		}
	});

	// Load initial data
	loadPosts();
</script>

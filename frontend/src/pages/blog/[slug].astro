---
export const prerender = false;
import Layout from '../../layouts/Layout.astro';

const { slug } = Astro.params;
const API_URL = import.meta.env.PUBLIC_API_URL || '';
---

<Layout title="Blog Post" description="블로그 글 읽기">
  <div id="post-container">
    <!-- Loading state -->
    <div id="loading" class="text-center py-20">
      <p class="text-warm-500 text-sm">로딩 중...</p>
    </div>
  </div>

  <!-- Edit Post Modal -->
  <div id="post-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 overflow-y-auto backdrop-blur-sm">
    <div class="bg-warm-900 border border-warm-800 p-6 rounded-lg w-full max-w-2xl m-4">
      <h3 id="modal-title" class="text-xl font-semibold text-warm-100 mb-4">글 수정</h3>
      <form id="post-form">
        <input type="hidden" id="post-id" />
        <div class="mb-4">
          <label class="block text-warm-400 text-sm mb-2">제목 *</label>
          <input
            type="text"
            id="post-title"
            required
            class="w-full px-3 py-2 bg-warm-950 text-warm-100 rounded border border-warm-700 focus:border-accent outline-none transition-colors text-sm"
          />
        </div>
        <div class="mb-4">
          <label class="block text-warm-400 text-sm mb-2">요약 *</label>
          <textarea
            id="post-excerpt"
            required
            rows="2"
            class="w-full px-3 py-2 bg-warm-950 text-warm-100 rounded border border-warm-700 focus:border-accent outline-none transition-colors text-sm"
          ></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-warm-400 text-sm mb-2">본문 *</label>
          <textarea
            id="post-content"
            required
            rows="8"
            class="w-full px-3 py-2 bg-warm-950 text-warm-100 rounded border border-warm-700 focus:border-accent outline-none transition-colors text-sm"
          ></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-warm-400 text-sm mb-2">태그 (쉼표로 구분)</label>
          <input
            type="text"
            id="post-tags"
            placeholder="예: JavaScript, React, Web"
            class="w-full px-3 py-2 bg-warm-950 text-warm-100 rounded border border-warm-700 focus:border-accent outline-none transition-colors text-sm"
          />
        </div>
        <div class="mb-4">
          <label class="flex items-center text-warm-400 text-sm">
            <input type="checkbox" id="post-featured" class="mr-2" />
            Featured (메인 페이지에 표시)
          </label>
        </div>
        <div class="flex gap-2 justify-end">
          <button
            type="button"
            id="cancel-btn"
            class="px-3 py-1.5 bg-warm-800 hover:bg-warm-700 rounded text-sm text-warm-300 transition-colors"
          >
            취소
          </button>
          <button
            type="submit"
            class="px-3 py-1.5 bg-accent hover:bg-accent-hover text-warm-950 rounded text-sm font-medium transition-colors"
          >
            저장
          </button>
        </div>
      </form>
    </div>
  </div>
</Layout>

<script define:vars={{ slug, API_URL }}>
  let currentPost = null;
  let isAuthenticated = false;

  // KaTeX CSS 동적 로드
  function loadKatexCSS() {
    if (document.getElementById('katex-css')) return;
    const link = document.createElement('link');
    link.id = 'katex-css';
    link.rel = 'stylesheet';
    link.href = 'https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css';
    link.crossOrigin = 'anonymous';
    document.head.appendChild(link);
  }

  // Check authentication status
  async function checkAuth() {
    try {
      const response = await fetch(`${API_URL}/api/auth/check`, {
        credentials: 'include'
      });
      const data = await response.json();
      isAuthenticated = data.isAuthenticated;
    } catch (error) {
      console.error('Auth check failed:', error);
      isAuthenticated = false;
    }
  }

  async function loadPost() {
    const loading = document.getElementById('loading');
    const container = document.getElementById('post-container');

    // Check auth first
    await checkAuth();

    try {
      const response = await fetch(`${API_URL}/api/posts/${slug}`);

      if (!response.ok) {
        if (response.status === 404) {
          container.innerHTML = `
            <div class="text-center py-20">
              <h1 class="text-2xl font-semibold text-warm-100 mb-4">글을 찾을 수 없습니다</h1>
              <p class="text-warm-500 text-sm mb-8">요청하신 글이 존재하지 않거나 삭제되었습니다.</p>
              <a href="/blog" class="text-warm-400 hover:text-accent text-sm transition-colors duration-300">&larr; 모든 글 목록으로</a>
            </div>
          `;
          return;
        }
        throw new Error('Failed to fetch post');
      }

      const post = await response.json();
      currentPost = post;

      // 수학 수식이 있으면 KaTeX CSS 로드
      if (post.has_math) {
        loadKatexCSS();
      }

      // Hide loading
      if (loading) loading.remove();

      // Render post
      container.innerHTML = `
        <article>
          <div class="mb-10">
            <a href="/blog" class="text-warm-500 hover:text-accent text-sm transition-colors duration-300 mb-6 block">&larr; 모든 글 목록으로</a>
            <h1 class="text-2xl font-semibold text-warm-100 mb-3 tracking-tight">${post.title}</h1>
            <div class="flex items-center gap-2 text-sm text-warm-500 mb-4">
              <time>${new Date(post.date).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}</time>
              ${post.tags && post.tags.length > 0 ? `
                <span class="text-warm-700">/</span>
                <div class="flex gap-1.5">
                  ${post.tags.map(tag => `<span class="text-warm-500">${tag}</span>`).join('')}
                </div>
              ` : ''}
            </div>
            ${isAuthenticated ? `
              <div class="flex gap-2">
                <button id="edit-btn" class="px-3 py-1 bg-warm-800 hover:bg-warm-700 rounded text-xs text-warm-300 font-medium transition-colors">
                  수정
                </button>
                <button id="delete-btn" class="px-3 py-1 bg-red-900/50 hover:bg-red-900/80 text-red-300 rounded text-xs font-medium transition-colors">
                  삭제
                </button>
              </div>
            ` : ''}
          </div>
          <div class="text-warm-300 leading-relaxed">
            <p class="text-warm-400 italic mb-8">${post.excerpt}</p>
            <div class="w-full h-px bg-warm-800/50 my-8"></div>
            <div id="post-body" class="prose prose-invert max-w-none prose-p:leading-relaxed"></div>
          </div>
        </article>
      `;

      // Update page title
      document.title = `${post.title} - 장찬욱`;

      // Set content HTML separately to avoid escaping
      const contentDiv = document.getElementById('post-body');
      if (contentDiv) {
        // Use the pre-rendered HTML from the API directly.
        contentDiv.innerHTML = post.content_html || post.content_markdown || post.content || '';
      }

      // Add event listeners for edit and delete buttons (only if authenticated)
      if (isAuthenticated) {
        document.getElementById('edit-btn')?.addEventListener('click', openEditModal);
        document.getElementById('delete-btn')?.addEventListener('click', handleDelete);
      }
    } catch (error) {
      console.error('Error loading post:', error);
      container.innerHTML = `
        <div class="text-center py-20">
          <h1 class="text-2xl font-semibold text-warm-100 mb-4">오류가 발생했습니다</h1>
          <p class="text-warm-500 text-sm mb-8">글을 불러오는 중 문제가 발생했습니다.</p>
          <a href="/blog" class="text-warm-400 hover:text-accent text-sm transition-colors duration-300">&larr; 모든 글 목록으로</a>
        </div>
      `;
    }
  }

  // Modal functions
  const modal = document.getElementById('post-modal');
  const form = document.getElementById('post-form');
  const cancelBtn = document.getElementById('cancel-btn');

  function openEditModal() {
    if (!currentPost) return;

    (document.getElementById('post-id')).value = currentPost.id;
    (document.getElementById('post-title')).value = currentPost.title;
    (document.getElementById('post-excerpt')).value = currentPost.excerpt || '';
    (document.getElementById('post-content')).value = currentPost.content_markdown || currentPost.content || '';
    (document.getElementById('post-tags')).value = currentPost.tags ? currentPost.tags.join(', ') : '';
    (document.getElementById('post-featured')).checked = currentPost.featured || false;

    modal?.classList.remove('hidden');
  }

  function closeModal() {
    modal?.classList.add('hidden');
  }

  async function handleDelete() {
    if (!currentPost) return;

    if (!confirm('정말 이 글을 삭제하시겠습니까?')) return;

    try {
      const response = await fetch(`${API_URL}/api/posts/${currentPost.id}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        alert('글이 삭제되었습니다.');
        window.location.href = '/blog';
      } else {
        throw new Error('Failed to delete post');
      }
    } catch (error) {
      console.error('Failed to delete post:', error);
      alert('삭제에 실패했습니다.');
    }
  }

  cancelBtn?.addEventListener('click', closeModal);

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const id = (document.getElementById('post-id')).value;
    const title = (document.getElementById('post-title')).value;
    const excerpt = (document.getElementById('post-excerpt')).value;
    const content = (document.getElementById('post-content')).value;
    const tagsInput = (document.getElementById('post-tags')).value;
    const featured = (document.getElementById('post-featured')).checked;

    const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

    try {
      const response = await fetch(`${API_URL}/api/posts/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, excerpt, content, tags, featured })
      });

      if (response.ok) {
        const updatedPost = await response.json();
        closeModal();
        // slug가 변경되었으면 새 URL로 이동
        if (updatedPost.slug && updatedPost.slug !== slug) {
          window.location.href = `/blog/${updatedPost.slug}`;
        } else {
          await loadPost();
        }
      } else {
        throw new Error('Failed to update post');
      }
    } catch (error) {
      console.error('Failed to save post:', error);
      alert('저장에 실패했습니다.');
    }
  });

  // Load post on page load
  loadPost();
</script>

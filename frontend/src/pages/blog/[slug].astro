---
import Layout from '../../layouts/Layout.astro';

const { slug } = Astro.params;
---

<Layout title="Blog Post" description="블로그 글 읽기">
  <div id="post-content" class="max-w-3xl mx-auto">
    <!-- Loading state -->
    <div id="loading" class="text-center py-20">
      <p class="text-gray-400">로딩 중...</p>
    </div>
  </div>
</Layout>

<script define:vars={{ slug }}>
  const API_URL = '';

  async function loadPost() {
    const loading = document.getElementById('loading');
    const container = document.getElementById('post-content');

    try {
      const response = await fetch(`${API_URL}/api/posts/${slug}`);

      if (!response.ok) {
        if (response.status === 404) {
          container.innerHTML = `
            <div class="text-center py-20">
              <h1 class="text-4xl font-bold mb-4">글을 찾을 수 없습니다</h1>
              <p class="text-gray-400 mb-8">요청하신 글이 존재하지 않거나 삭제되었습니다.</p>
              <a href="/blog" class="text-blue-400 hover:underline">← 모든 글 목록으로 돌아가기</a>
            </div>
          `;
          return;
        }
        throw new Error('Failed to fetch post');
      }

      const post = await response.json();

      // Hide loading
      if (loading) loading.remove();

      // Render post
      container.innerHTML = `
        <article>
          <div class="mb-8">
            <a href="/blog" class="text-blue-400 hover:underline mb-4 block">&larr; 모든 글 목록으로 돌아가기</a>
            <h1 class="text-4xl font-bold mb-2">${post.title}</h1>
            <div class="flex items-center gap-2 text-sm text-gray-400">
              <time>${new Date(post.date).toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}</time>
              ${post.tags && post.tags.length > 0 ? `
                <span>•</span>
                <div class="flex gap-2">
                  ${post.tags.map(tag => `<span class="text-blue-400">#${tag}</span>`).join('')}
                </div>
              ` : ''}
            </div>
          </div>
          <div class="text-gray-300 text-lg leading-relaxed">
            <p class="text-xl italic text-gray-400 mb-8">${post.excerpt}</p>
            <div class="w-full h-px bg-gray-800 my-8"></div>
            <div class="prose prose-invert max-w-none prose-p:text-lg prose-p:leading-relaxed whitespace-pre-wrap">${post.content}</div>
          </div>
        </article>
      `;

      // Update page title
      document.title = `${post.title} - CS {["장찬욱"]};`;
    } catch (error) {
      console.error('Error loading post:', error);
      container.innerHTML = `
        <div class="text-center py-20">
          <h1 class="text-4xl font-bold mb-4">오류가 발생했습니다</h1>
          <p class="text-gray-400 mb-8">글을 불러오는 중 문제가 발생했습니다.</p>
          <a href="/blog" class="text-blue-400 hover:underline">← 모든 글 목록으로 돌아가기</a>
        </div>
      `;
    }
  }

  // Load post on page load
  loadPost();
</script>

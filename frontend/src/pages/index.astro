---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import Hero from '../components/Hero.astro';
import BlogCard from '../components/BlogCard.astro';
import ProjectCard from '../components/ProjectCard.astro';

// SSR에서는 localhost:3000 사용, 클라이언트에서는 상대 경로 사용
const API_URL = import.meta.env.SSR
  ? 'http://localhost:3000'
  : (import.meta.env.PUBLIC_API_URL || '');
console.log('[INDEX] SSR:', import.meta.env.SSR, 'API_URL:', API_URL);

// Fetch latest blog posts (최신 글 3개)
let featuredPosts = [];
let postsError = null;
try {
	const url = `${API_URL}/api/posts`;
	console.log('[INDEX] Fetching posts from:', url);
	const response = await fetch(url);
	console.log('[INDEX] Posts response status:', response.status);
	if (response.ok) {
		const allPosts = await response.json();
		console.log('[INDEX] Fetched posts count:', allPosts.length);
		// 최신 3개만 표시
		featuredPosts = allPosts.slice(0, 3);
	} else {
		postsError = `HTTP ${response.status}`;
	}
} catch (error) {
	console.error('[INDEX] Failed to fetch posts:', error);
	postsError = error.message;
}

// Fetch recent projects (최신 프로젝트 3개)
let recentProjects = [];
let projectsError = null;
try {
	const url = `${API_URL}/api/projects`;
	console.log('[INDEX] Fetching projects from:', url);
	const response = await fetch(url);
	console.log('[INDEX] Projects response status:', response.status);
	if (response.ok) {
		const allProjects = await response.json();
		console.log('[INDEX] Fetched projects count:', allProjects.length);
		// 최신 3개만 표시 (이미 created_at DESC 정렬됨)
		recentProjects = allProjects.slice(0, 3);
	} else {
		projectsError = `HTTP ${response.status}`;
	}
} catch (error) {
	console.error('[INDEX] Failed to fetch projects:', error);
	projectsError = error.message;
}
---

<Layout title="장찬욱" description="개발자의 학습과 성장을 기록하는 블로그">
	<Hero />

	<!-- Featured Blog Posts -->
	<section class="pb-16">
		<div class="flex justify-between items-baseline mb-6">
			<h2 class="text-lg font-medium text-warm-100">최신 글</h2>
			<a href="/blog" class="text-sm text-warm-500 hover:text-accent transition-colors duration-300">
				전체 보기
			</a>
		</div>
		<div>
			{featuredPosts.length > 0 ? (
				featuredPosts.map(post => (
					<BlogCard
						title={post.title}
						excerpt={post.excerpt}
						date={post.date}
						slug={post.slug}
						tags={post.tags}
					/>
				))
			) : (
				<p class="text-warm-500 text-center py-12 text-sm">
					{postsError
						? `에러: ${postsError} (API_URL: ${API_URL || '미설정'})`
						: '블로그 글을 불러오는 중입니다...'}
				</p>
			)}
		</div>
	</section>

	<!-- Recent Projects -->
	<section class="pb-16">
		<div class="flex justify-between items-baseline mb-6">
			<h2 class="text-lg font-medium text-warm-100">최근 프로젝트</h2>
			<a href="/projects" class="text-sm text-warm-500 hover:text-accent transition-colors duration-300">
				전체 보기
			</a>
		</div>
		<div class="grid md:grid-cols-2 gap-4">
			{recentProjects.length > 0 ? (
				recentProjects.map(project => (
					<ProjectCard
						title={project.title}
						description={project.description}
						detailLink={`/projects/${project.id}`}
						githubUrl={project.github_url}
						tags={project.stack || []}
					/>
				))
			) : (
				<p class="text-warm-500 text-center py-12 col-span-2 text-sm">
					{projectsError
						? `에러: ${projectsError} (API_URL: ${API_URL || '미설정'})`
						: '프로젝트가 없습니다.'}
				</p>
			)}
		</div>
	</section>

	<!-- About Section -->
	<section class="pb-8">
		<div class="p-6 rounded-lg border border-warm-800/50 bg-warm-900/20">
			<h2 class="text-lg font-medium text-warm-100 mb-3">소개</h2>
			<p class="text-warm-400 text-sm leading-relaxed mb-3">
				백엔드와 인프라에 관심이 많은 개발자입니다.
				실제로 동작하는 것을 만들면서 배우는 걸 좋아합니다.
			</p>
			<p class="text-warm-400 text-sm leading-relaxed">
				이 블로그는 제가 배운 것들을 기록하고 공유하기 위한 공간입니다.
				Astro와 Express.js를 활용하여 직접 구축했습니다.
			</p>
		</div>
	</section>
</Layout>

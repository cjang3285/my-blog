---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import Hero from '../components/Hero.astro';
import BlogCard from '../components/BlogCard.astro';
import ProjectCard from '../components/ProjectCard.astro';

const API_URL = import.meta.env.PUBLIC_API_URL || '';
console.log('[INDEX] API_URL:', API_URL);

// Fetch latest blog posts (최신 글 3개)
let featuredPosts = [];
let postsError = null;
try {
	const url = `${API_URL}/api/posts`;
	console.log('[INDEX] Fetching posts from:', url);
	const response = await fetch(url);
	console.log('[INDEX] Posts response status:', response.status);
	if (response.ok) {
		const allPosts = await response.json();
		console.log('[INDEX] Fetched posts count:', allPosts.length);
		// 최신 3개만 표시
		featuredPosts = allPosts.slice(0, 3);
	} else {
		postsError = `HTTP ${response.status}`;
	}
} catch (error) {
	console.error('[INDEX] Failed to fetch posts:', error);
	postsError = error.message;
}

// Fetch completed projects (완료된 프로젝트만)
let completedProjects = [];
let projectsError = null;
try {
	const url = `${API_URL}/api/projects`;
	console.log('[INDEX] Fetching projects from:', url);
	const response = await fetch(url);
	console.log('[INDEX] Projects response status:', response.status);
	if (response.ok) {
		const allProjects = await response.json();
		console.log('[INDEX] Fetched projects count:', allProjects.length);
		// kanban_status가 'done'이고 유효한 데이터를 가진 프로젝트만 필터링
		completedProjects = allProjects
			.filter(p => p.kanban_status === 'done' && p.title && p.description)
			.slice(0, 6); // 최대 6개
		console.log('[INDEX] Completed projects count:', completedProjects.length);
	} else {
		projectsError = `HTTP ${response.status}`;
	}
} catch (error) {
	console.error('[INDEX] Failed to fetch projects:', error);
	projectsError = error.message;
}
---

<Layout title="Home - My Blog" description="개발자의 학습과 성장을 기록하는 블로그">
	<Hero />

	<!-- Featured Blog Posts -->
	<section class="py-12">
		<div class="flex justify-between items-center mb-8">
			<h2 class="text-3xl font-bold">최신 글</h2>
			<a href="/blog" class="text-blue-600 dark:text-blue-400 hover:underline font-medium">
				전체 보기 →
			</a>
		</div>
		<div class="grid gap-6">
			{featuredPosts.length > 0 ? (
				featuredPosts.map(post => (
					<BlogCard
						title={post.title}
						excerpt={post.excerpt}
						date={post.date}
						slug={post.slug}
						tags={post.tags}
					/>
				))
			) : (
				<p class="text-gray-500 dark:text-gray-400 text-center py-12">
					{postsError
						? `에러: ${postsError} (API_URL: ${API_URL || '미설정'})`
						: '블로그 글을 불러오는 중입니다...'}
				</p>
			)}
		</div>
	</section>

	<!-- Featured Projects -->
	<section class="py-12">
		<div class="flex justify-between items-center mb-8">
			<h2 class="text-3xl font-bold">완료된 프로젝트</h2>
			<a href="/projects" class="text-blue-600 dark:text-blue-400 hover:underline font-medium">
				전체 보기 →
			</a>
		</div>
		<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
			{completedProjects.length > 0 ? (
				completedProjects.map(project => (
					<ProjectCard
						title={project.title}
						description={project.description}
						detailLink={`/projects/${project.id}`}
						githubUrl={project.github_url}
						tags={project.stack || []}
					/>
				))
			) : (
				<p class="text-gray-500 dark:text-gray-400 text-center py-12 col-span-3">
					{projectsError
						? `에러: ${projectsError} (API_URL: ${API_URL || '미설정'})`
						: '완료된 프로젝트가 없습니다.'}
				</p>
			)}
		</div>
	</section>

	<!-- About Section -->
	<section class="py-12">
		<div class="p-8 rounded-xl bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-950/30 dark:to-indigo-950/30 border border-blue-200 dark:border-blue-800">
			<h2 class="text-2xl font-bold mb-4">About</h2>
			<p class="text-gray-700 dark:text-gray-300 leading-relaxed mb-4">
				지속적으로 배우고 성장하는 개발자입니다. 프론트엔드부터 백엔드까지,
				풀스택 개발 역량을 키우며 실제로 동작하는 것을 만드는 데 집중합니다.
			</p>
			<p class="text-gray-700 dark:text-gray-300 leading-relaxed">
				이 블로그는 제가 배운 것들을 기록하고 공유하기 위한 공간입니다.
				Astro와 Express.js를 활용하여 직접 구축했습니다.
			</p>
		</div>
	</section>
</Layout>
